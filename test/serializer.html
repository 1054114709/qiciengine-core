<!DOCTYPE html>
<html>
    <head>
        <title>序列化接口测试</title>
        <meta charset="UTF-8">

        <script src="../lib/phaser.js" type="text/javascript"></script>
        <script src="../build/qc-core-debug.js" type="text/javascript"></script>
    </head>
    <body>
    <script type="application/javascript" src="js/builtinStartGame.js"></script>

    <script type="application/javascript">
        game._onFirstScenePreload = function() {
            game.assets.load('monsters', 'assets/sprites/pixi_monsters.bin');
            game.assets.load('ui', 'assets/sprites/ui.bin');
            game.assets.load('bot', 'assets/sprites/running_bot.bin');
            game.assets.load('ui_image', 'assets/prefab/ui_image.bin');
            game.assets.load("ov", ['assets/audio/love.mp3.bin']);
        }

        game._onFirstSceneLoaded = function() {
            // 建立一个包含各个组件的场景
            // UIRoot
            //   Button
            //   Sprite
            //   Toggle
            //   UIImage
            //   UIText
            uiRoot = new qc.UIRoot(game);

            button = game.add.button(uiRoot);
            button.texture = game.assets.find('monsters');
            button.text.text = '图片变换按钮';
            button.frame = 'eggHead.png';
            var c = button.getScript('qc.TransitionBehaviour');
            c.normalTexture = 'eggHead.png';
            c.pressedTexture = 'flowerTop.png';
            c.disabledTexture = 'helmlok.png';
            c.transition = qc.Transition.TEXTURE_SWAP;

            sprite = game.add.sprite(uiRoot);
            sprite.x = 150;
            sprite.y = 100;
            sprite.texture = game.assets.find('bot');
            sprite.playAnimation('run1', 1.5 /* 倍率 */, true /* 循环 */);

            toggle = game.add.toggle(uiRoot);
            toggle.background.texture = game.assets.find('ui');
            toggle.checkMark.texture = game.assets.find('ui');
            toggle.background.frame = 'buttonBackground.png';
            toggle.checkMark.frame = 'check.png';
            toggle.checkMark.x = 20;
            toggle.checkMark.y = 10;
            toggle.text.text = '开关1';
            toggle.x = 50;
            toggle.y = 200;

            image = game.add.image(uiRoot);
            image.texture = game.assets.find('monsters');
            image.x = 50;
            image.y = 300;

            sound = game.add.sound(uiRoot);
            sound.audio = game.assets.find('ov');
            sound.play();

            text = game.add.text(uiRoot);
            text.text = '你好，魏树木';
            text.x = 300;
            text.bold = true;

            textField = game.add.textField(uiRoot);
            textField.text = '编辑框';
            textField.y = 0;
            textField.x = 600;

            // 自定义个逻辑脚本
            var s = qc.Serializer;
            test = qc.defineBehaviour('testGame.Test', null, null, {
                _image : s.NODE,
                _prefab : s.PREFAB,
                _prefabs : s.PREFABS,
                _toggle : s.NODE,
                _buttonText : s.NODE,
                _texture : s.TEXTURE,
                _array : s.INTS,
                _object : s.MAPPING
            });
            test.prototype.awake = function() {
                if (this._image) {
                    console.log('Behaviour序列化完毕，数据如下：');
                    console.log(this._image);
                    console.log(this._prefab);
                    console.log(this._prefabs);
                    console.log(this._toggle);
                    console.log(this._buttonText);
                    console.log(this._texture);
                    console.log(this._array);
                    console.log(this._object);
                }
            }

            // 为image挂载个逻辑脚本，逻辑脚本引用了其他资源
            var b = image.addScript('testGame.Test');
            b._image = b.gameObject;
            b._prefab = game.assets.find('ui_image');
            b._prefabs = [b._prefab, b._prefab];
            b._toggle = toggle;
            b._buttonText = button.text;
            b._texture = game.assets.find('monsters');
            b._array = [0, 1];
            b._object = {
                year : 1981,
                name : "魏树木"
            };

            // 序列化之
            var context = {};
            json = game.serializer.buildBundle(uiRoot, context);
            json.dependences = game.serializer.combineDependence(context);

            // 反序列化出来
            uiRoot.destroy();
            uiRoot2 = game.serializer.restoreBundle(json);

            // 复制一个出来
            uiRoot3 = game.add.clone(uiRoot2);

            // 序列化场景
            context = {};
            json = game.serializer.buildBundle(game.world, context);
            json.dependences = game.serializer.combineDependence(context);
            console.log(JSON.stringify(json));
        }
    </script>
    </body>
</html>
