<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>孩子层次测试</title>
    <script src="../lib/phaser.js" type="text/javascript"></script>
    <script src="../lib/qc-widget.js" type="text/javascript"></script>
    <script src="../build/qc-core-debug.js" type="text/javascript"></script>
    <script src="GameView.js" type="text/javascript"></script>
    <script src="GameData.js" type="text/javascript"></script>
    <script src="GameTree.js" type="text/javascript"></script>
    <script src="GameTable.js" type="text/javascript"></script>

    <script>
        allConf = {
            'daozei': {
                'url': 'assets/dragonbones/daozei.bin',
                'x': 80,
                'y': 200
            }
        };
        function checkEvent(event) {
            if (!(event instanceof qc.BaseInputEvent)) {
                throw 'Error Event:' + event.toString();
            }
        }
        function init() {
            game = new qc.Game(800, 600, "", {
                init: function() {
                    world = game.world;
                    tree = new GameTree(game);
                    table = new GameTable(tree.dataModel);
                    gameView = new GameView(game);

                    widthText = new qc.widget.TextField();
                    widthText.value = '500';

                    heightText = new qc.widget.TextField();
                    heightText.value = '300';

                    toggleButton = new qc.widget.ToggleButton();
                    toggleButton.text = '缩放显示';
                    toggleButton.on('click', function() {
                        var size = {width: parseInt(widthText.value), height: parseInt(heightText.value)};
                        gameView.size = toggleButton.selected ? size : null;
                    });

                    gameInputEnabled = new qc.widget.CheckBox();
                    gameInputEnabled.text = 'Game Input Enabled';
                    gameInputEnabled.selected = true;
                    gameInputEnabled.on('click', function() {
                        game.input.enable = gameInputEnabled.selected;
                    });

                    h5Interactive = new qc.widget.CheckBox();
                    h5Interactive.text = 'H5 Interactive';
                    h5Interactive.selected = true;
                    h5Interactive.on('click', function() {
                        h5.interactive = h5Interactive.selected;
                    });

                    var h5s = qc.defineBehaviour('H5Script', qc.Behaviour, function() {
                    }, {});

                    items = [widthText, heightText, toggleButton, gameInputEnabled, h5Interactive];
                    names = ['onDown', 'onUp', 'onClick', 'onDragStart', 'onDrag', 'onDragEnd', 'onOver', 'onOut'];
                    names.forEach(function(name) {
                        var checkBox = window['cb_' + name] = new qc.widget.CheckBox();
                        checkBox.text = name;
                        items.push(checkBox);
                        H5Script.prototype[name] = function(event) {
                            checkEvent(event);
                            console.log('%cscript ' + this.gameObject.name + ' ' + name, 'background: yellow; color: black');
                            return checkBox.selected;
                        };
                    });

                    toolbar = new qc.widget.Toolbar();
                    toolbar.setItems(items);

                    container = new qc.widget.Container();
                    container.layout = new qc.widget.layout.BorderLayout(container);
                    container.setItems([
                        {
                            region: 'top',
                            element: toolbar
                        },
                        {
                            region: 'left',
                            element: tree,
                            width: 200
                        },
                        {
                            region: 'center',
                            element: gameView
                        },
                        {
                            region: 'right',
                            element: table,
                            width: 200
                        }
                    ]);
                    container.addToDOM();
                },
                preload: function() {
                    game.assets.load('sencha', 'tree/sencha.bin');
                    game.assets.load('circle', 'tree/circle.bin');
                    game.assets.load('h5', 'tree/h5.bin');
                    game.assets.load('pentagon', 'tree/pentagon.bin');
                    game.assets.load('square', 'tree/square.bin');
                    game.stage.backgroundColor = '0x3498db';

                    for (var name in allConf) {
                        game.assets.load(name, allConf[name].url);
                    }
                },
                create: function() {
                    sencha = createImage('sencha', null, 300, 20);
                    circle = createImage('circle', sencha);
                    pentagon = createImage('pentagon', sencha, 60, 60);
                    square = createImage('square');
                    logInfo = game.add.text();
                    logInfo.x = 300;
                    logInfo.y = 300;
                    h5 = createImage('h5', square, 30, 20);

                    allAni = [];
                    for (var name in allConf) {
                        conf = allConf[name];
                        sprite = new qc.Sprite(game);
                        sprite.scaleX = 0.5;
                        sprite.scaleY = 0.5;
                        sprite.name = name;
                        sprite.texture = game.assets.find(name);
                        allAni.push(sprite);

                        parent = createImage('square');
                        parent.width = 50;
                        parent.height = 50;
                        parent.x = conf.x;
                        parent.y = conf.y;
                        parent.addChild(sprite);
                    }

                    tree.expandAll();
//
//                    game.input.onPinchStart.add(function(distance, globalPoint1, globalPoint2, event){
//                        console.log('pinchStart', distance);
//                    });
//                    game.input.onPinch.add(function(lastDistance, distance, globalPoint1, globalPoint2, event){
//                        console.log('pinch', lastDistance, distance);
//                        var center = h5.parent.toLocal({
//                            x: (globalPoint1.x + globalPoint2.x)/2,
//                            y: (globalPoint1.y + globalPoint2.y)/2
//                        });
//                        h5.x = center.x;
//                        h5.y = center.y;
//                        h5.pivot.x = 0.5;
//                        h5.pivot.y = 0.5;
//                    });
//                    game.input.onPinchEnd.add(function(event){
//                        console.log('pinchEnd');
//                    });
//
//
                    game.input.onKeyDown.add(function(keyCode) {
                        var input = game.input;
                        logKeyStatus('keydown', keyCode,
                            input.isAltDown(), input.isControlDown(),
                            input.isShiftDown(), input.isMetaDown());

                    });

                    game.input.onKeyUp.add(function(keyCode) {
                        var input = game.input;
                        logKeyStatus('keyup', keyCode,
                                input.isAltDown(), input.isControlDown(),
                                input.isShiftDown(), input.isMetaDown());
                    });
//
//                    game.input.onClick.add(function(node, event) {
//                        checkEvent(event);
//                        console.log('%cgame onClick ' + (node ? node.name : null), 'background: #3498db; color: white');
//                    });
//                    game.input.onDown.add(function(node, event) {
//                        checkEvent(event);
//                        console.log('%cgame onDown ' + (node ? node.name : null), 'background: #3498db; color: white');
//                        if (node) {
//                            node.colorTint = 0xFF0000;
//                        }
//                        tree.dataModel.selectionModel.selection = node ? tree.dataModel.getDataById(node.uuid) : null;
//                    });
//                    game.input.onUp.add(function(node, event) {
//                        checkEvent(event);
//                        console.log('%cgame onUp ' + (node ? node.name : null), 'background: #3498db; color: white');
//                        if (node) {
//                            node.colorTint = 0xFFFFFF;
//                        }
//                    });

                    h5.onDown.add(function(node, event) {
                        checkEvent(event);
                        console.log('%c' + node.name + ' onDown', 'background: #00FF54; color: #565656');
                    });
                    h5.onUp.add(function(node, event) {
                        checkEvent(event);
                        console.log('%c' + node.name + ' onUp', 'background: #00FF54; color: #565656');
                    });
                    h5.onClick.add(function(node, event) {
                        checkEvent(event);
                        console.log('%c' + node.name + ' onClick', 'background: #00FF54; color: #565656');
                    });

                    h5.onDragStart.add(function(node, event) {
                        checkEvent(event);
                        savePoint = new qc.Point(node.x, node.y);
                        console.log('%c' + node.name + ' onDragStart', 'background: red; color: white');
                    });
                    h5.onDrag.add(function(node, event) {
                        checkEvent(event);
                        node.x = event.source.x;
                        node.y = event.source.y;
                        console.log('%c' + node.name + ' onDrag', 'background: red; color: white');
                    });
                    h5.onDragEnd.add(function(node, event) {
                        checkEvent(event);
                        if (!event.result) {
                            node.x = savePoint.x;
                            node.y = savePoint.y;
                        }
                        console.log('%c' + node.name + ' onDragEnd', 'background: red; color: white');
                    });
                    h5.onWheel.add(function(node, event) {
                        checkEvent(event);
                        console.log('%c' + node.name + ' onWheel, deltaX :' + event.source.deltaX + ', deltaY :' + event.source.deltaY,
                                'background: green; color: white');
                    });
                    h5.addScript('H5Script');


                    sencha.onClick.add(function(node, event) {
                        checkEvent(event);
                        console.log('%c' + node.name + ' onClick', 'background: blue; color: white');
                    });
                },
                update: function() {
                    table.iv();

                    allAni.forEach(function(ob) {
                        var list = ob.animationNameList;
                        if (!list)
                            return;

                        if (!ob.countFrame) {
                            ob.countFrame = 1;
                            ob.playAnimation(list[parseInt(Math.random() * list.length)]);
                        } else {
                            ob.countFrame++;
                            if (ob.countFrame % 100 == 0)
                                ob.playAnimation(list[parseInt(Math.random() * list.length)]);
                        }
                    });

                    var inputMsg = [];
                    var i = game.input.keyCount;
                    var arr = game.input.keyCodes;
                    inputMsg.push('input count: ' + i);
                    while (i--) {
                        inputMsg.push('---down key: ' + arr[i]);
                    }

                    i = game.input.mouseCount;
                    arr = game.input.mouseIds;
                    inputMsg.push('mouse count: ' + i);
                    while (i--) {
                        var mouseId = arr[i];
                        var mouse = game.input.getPointer(mouseId);
                        inputMsg.push('---down mouse: ' + arr[i] + ',x:' + mouse.x + ',y:' + mouse.y);
                    }


                    i = game.input.touchCount;
                    arr = game.input.touchIds;
                    inputMsg.push('touch count: ' + i);
                    while (i--) {
                        var touchId = arr[i];
                        var touch = game.input.getPointer(touchId);
                        inputMsg.push('---down touch: ' + arr[i] + ',x:' + touch.x + ',y:' + touch.y);
                    }

                    logInfo.text = inputMsg.join('\n');
                }
            });
        }

        function createImage(texture, parent, x, y) {
            var image = new qc.UIImage(game);
            image.texture = game.assets.find(texture);
            image.resetNativeSize();
            image.interactive = true;
            image.name = texture;
            image.x = x || 0;
            image.y = y || 0;
            if (parent) {
                parent.addChild(image);
            }
            return image;
        }


        function logKeyStatus(status, keycode, isAlt, isCtrl, isShift, isMeta)
        {
            console.log(status, ',keyCode:', keycode, ',alt:', isAlt, ',ctrl:', isCtrl,
                    ',shift:', isShift, ',meta:', isMeta);
        }
    </script>
    <style type="text/css">
        div{cursor: url("assets/sprites/firstaid.png"),auto; }
    </style>
</head>
<body onload="init();">

</body>
</html>